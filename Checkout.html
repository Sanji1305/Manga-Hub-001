<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>MangaHub | Checkout</title>
    <!-- Bootstrap CSS -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="/styles/style.css" />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css"
    />
    <style>
      /* Minimal dark+red theme ONLY for checkout section */
      .checkout-dark-theme {
        background: #18181b !important;
        color: #fff !important;
      }
      .checkout-dark-theme .card {
        background: #232326 !important;
        border-radius: 14px;
        border: none;
        box-shadow: 0 4px 24px rgba(0, 0, 0, 0.18);
      }
      .checkout-dark-theme .card-title,
      .checkout-dark-theme h2,
      .checkout-dark-theme h5,
      .checkout-dark-theme label,
      .checkout-dark-theme .fw-bold {
        color: #ff2d2d !important;
        font-weight: 700 !important;
      }
      .checkout-dark-theme .form-label,
      .checkout-dark-theme .form-select,
      .checkout-dark-theme .form-control,
      .checkout-dark-theme textarea,
      .checkout-dark-theme input[type="text"],
      .checkout-dark-theme input[type="email"] {
        background: #18181b !important;
        color: #fff !important;
        border: 1.5px solid #333 !important;
        border-radius: 8px !important;
      }
      .checkout-dark-theme .form-control:focus,
      .checkout-dark-theme .form-select:focus,
      .checkout-dark-theme textarea:focus {
        border-color: #ff2d2d !important;
        background: #232326 !important;
        color: #fff !important;
        box-shadow: 0 0 0 2px #ff2d2d33 !important;
      }
      .checkout-dark-theme .form-control::placeholder,
      .checkout-dark-theme input[type="email"]::placeholder {
        color: #bbb !important;
        opacity: 1 !important;
      }
      .checkout-dark-theme .btn-success,
      .checkout-dark-theme .btn-success:focus {
        background: linear-gradient(90deg, #b31217 0%, #ff2d2d 100%) !important;
        border: none !important;
        color: #fff !important;
        font-weight: 600 !important;
        border-radius: 10px !important;
        box-shadow: 0 2px 8px rgba(179, 18, 23, 0.18);
        transition: background 0.2s, box-shadow 0.2s;
      }
      .checkout-dark-theme .btn-success:hover {
        background: linear-gradient(90deg, #ff2d2d 0%, #b31217 100%) !important;
        box-shadow: 0 4px 16px rgba(179, 18, 23, 0.22);
      }
      .checkout-dark-theme .alert-info,
      .checkout-dark-theme .alert-success,
      .checkout-dark-theme .alert-warning {
        background: #232326 !important;
        color: #fff !important;
        border: 1.5px solid #ff2d2d !important;
      }
      .checkout-dark-theme .list-group-item {
        background: #18181b !important;
        color: #fff !important;
        border: none !important;
      }
      .checkout-dark-theme .fw-semibold,
      .checkout-dark-theme .fw-bold,
      .checkout-dark-theme .form-label {
        color: #ff2d2d !important;
      }
      .checkout-dark-theme .form-select option {
        background: #232326;
        color: #fff;
      }
      .checkout-dark-theme .input-group-text {
        background: #232326 !important;
        color: #ff2d2d !important;
        border: none !important;
      }
      @media (max-width: 576px) {
        .checkout-dark-theme .card-body,
        .checkout-dark-theme .container {
          padding: 0.5rem !important;
        }
      }
      /* Autofill/validation icon fix for email input in dark theme */
      .checkout-dark-theme input[type="email"]::-webkit-input-placeholder {
        color: #bbb !important;
      }
      .checkout-dark-theme input[type="email"]:-webkit-autofill,
      .checkout-dark-theme input[type="email"]:-webkit-autofill:focus {
        -webkit-box-shadow: 0 0 0 1000px #18181b inset !important;
        -webkit-text-fill-color: #fff !important;
        caret-color: #fff !important;
        border-radius: 8px !important;
        background-color: #18181b !important;
        color-scheme: dark;
      }
      .checkout-dark-theme
        input[type="email"]::-webkit-contacts-auto-fill-button,
      .checkout-dark-theme
        input[type="email"]::-webkit-credentials-auto-fill-button {
        visibility: hidden;
        display: none !important;
        pointer-events: none;
        height: 0;
        width: 0;
      }
      .checkout-dark-theme input[type="email"]::-ms-reveal,
      .checkout-dark-theme input[type="email"]::-ms-clear {
        display: none;
      }
      .checkout-dark-theme input[type="email"]::-webkit-input-decoration {
        display: none !important;
      }
      .checkout-dark-theme .form-label,
      .checkout-dark-theme label {
        background: transparent !important;
        border: none !important;
        box-shadow: none !important;
        padding: 0 4px;
      }
    </style>
  </head>
  <body>
    <!-- Navbar -->
    <div id="navbar-container"></div>

    <!-- Checkout Section -->
    <section class="py-5 min-vh-100 checkout-dark-theme">
      <div class="container">
        <h2 class="fw-bold mb-4 text-center">Checkout</h2>
        <div class="row g-4">
          <div class="col-lg-7">
            <div class="card shadow-sm">
              <div class="card-body">
                <h5 class="card-title mb-3">Shipping Details</h5>
                <form>
                  <div class="mb-3">
                    <label for="name" class="form-label">Full Name</label>
                    <input
                      type="text"
                      class="form-control"
                      id="name"
                      placeholder="Enter your name"
                      required
                    />
                  </div>
                  <div class="mb-3">
                    <label for="email" class="form-label">Email address</label>
                    <input
                      type="email"
                      class="form-control"
                      id="email"
                      placeholder="Enter your email"
                      required
                    />
                  </div>
                  <div class="mb-3">
                    <label for="address" class="form-label">Address</label>
                    <textarea
                      class="form-control"
                      id="address"
                      rows="2"
                      placeholder="Enter your address"
                      required
                    ></textarea>
                  </div>
                  <div class="mb-3">
                    <label for="payment" class="form-label"
                      >Payment Method</label
                    >
                    <select class="form-select" id="payment" required>
                      <option value="" disabled selected>
                        Select payment method
                      </option>
                      <option value="cod">Cash on Delivery</option>
                      <option value="card">Credit/Debit Card</option>
                      <option value="upi">UPI</option>
                    </select>
                  </div>
                  <button
                    type="submit"
                    class="btn btn-success w-100"
                    id="placeOrderBtn"
                  >
                    Place Order
                  </button>
                </form>
              </div>
            </div>
          </div>
          <div class="col-lg-5">
            <div class="card shadow-sm">
              <div class="card-body">
                <h5 class="card-title mb-3">Order Summary</h5>
                <div id="checkoutSummary"></div>
                <div id="couponSection" class="mb-3"></div>
                <div class="alert alert-info small mb-0">
                  <i class="bi bi-shield-check"></i> 100% Secure Payment & Fast
                  Delivery
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Footer -->
    <div id="footer-container"></div>

    <!-- Bootstrap JS Bundle (with Popper) -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/js/script.js"></script>
    <script>
      function formatPrice(price) {
        return new Intl.NumberFormat("en-IN", {
          style: "currency",
          currency: "INR",
          minimumFractionDigits: 0,
        }).format(price);
      }

      function renderCheckoutSummary() {
        const cart = JSON.parse(localStorage.getItem("cart") || "[]");
        const summaryDiv = document.getElementById("checkoutSummary");
        const couponSection = document.getElementById("couponSection");
        let subtotal = 0,
          shipping = 0,
          tax = 0,
          total = 0;
        let couponDiscount = 0,
          couponType = null,
          couponValue = 0;
        let appliedCoupon = localStorage.getItem("appliedCoupon") || "";
        let couponMsg = "";

        if (!cart.length) {
          summaryDiv.innerHTML = `<div class='alert alert-warning text-center'>Your cart is empty. <a href='/Product Store.html'>Shop now</a></div>`;
          couponSection.innerHTML = "";
          return;
        }

        let itemsHtml = '<ul class="list-group list-group-flush mb-3">';
        cart.forEach((item) => {
          const itemTotal = item.price * item.quantity;
          subtotal += itemTotal;
          itemsHtml += `<li class='list-group-item d-flex justify-content-between align-items-center'>${
            item.title
          } <span>${formatPrice(itemTotal)}</span></li>`;
        });
        itemsHtml += "</ul>";

        // Coupon logic
        const validCoupons = {
          WELCOME10: 10,
          SAVE20: 20,
          MANGA15: 15,
          FREESHIP: "free_shipping",
        };
        if (appliedCoupon && validCoupons[appliedCoupon]) {
          if (typeof validCoupons[appliedCoupon] === "number") {
            couponType = "percent";
            couponValue = validCoupons[appliedCoupon];
            couponDiscount = subtotal * (couponValue / 100);
            couponMsg = `Coupon applied! ${couponValue}% discount.`;
          } else {
            couponType = "free_shipping";
            couponMsg = "Free shipping coupon applied!";
          }
        }

        shipping = subtotal > 500 || couponType === "free_shipping" ? 0 : 50;
        tax = subtotal * 0.18;
        total = subtotal + shipping + tax - couponDiscount;

        summaryDiv.innerHTML = `
          ${itemsHtml}
          <ul class="list-group list-group-flush mb-3">
            <li class="list-group-item d-flex justify-content-between align-items-center">
              <span>Subtotal</span>
              <span>${formatPrice(subtotal)}</span>
            </li>
            <li class="list-group-item d-flex justify-content-between align-items-center">
              <span>Shipping</span>
              <span>${shipping === 0 ? "Free" : formatPrice(shipping)}</span>
            </li>
            <li class="list-group-item d-flex justify-content-between align-items-center">
              <span>Tax (GST 18%)</span>
              <span>${formatPrice(tax)}</span>
            </li>
            ${
              couponDiscount > 0
                ? `<li class="list-group-item d-flex justify-content-between align-items-center text-success"><span>Coupon Discount</span><span>- ${formatPrice(
                    couponDiscount
                  )}</span></li>`
                : ""
            }
            <li class="list-group-item d-flex justify-content-between align-items-center fw-bold">
              <span>Total</span>
              <span>${formatPrice(total)}</span>
            </li>
          </ul>
        `;

        // Coupon input section
        couponSection.innerHTML = `
          <div class="input-group mb-2">
            <input type="text" class="form-control" placeholder="Enter coupon code" id="checkoutCouponInput" value="${appliedCoupon}" ${
          appliedCoupon ? "disabled" : ""
        } />
            <button class="btn btn-primary" id="checkoutApplyCouponBtn" ${
              appliedCoupon ? "disabled" : ""
            }>Apply</button>
          </div>
          <div id="checkoutCouponMsg" class="small ${
            couponMsg ? "text-success" : ""
          }">${couponMsg}</div>
        `;
        if (!appliedCoupon) {
          document.getElementById("checkoutApplyCouponBtn").onclick =
            function () {
              const input = document
                .getElementById("checkoutCouponInput")
                .value.trim()
                .toUpperCase();
              if (!input) {
                document.getElementById("checkoutCouponMsg").textContent =
                  "Please enter a coupon code.";
                document.getElementById("checkoutCouponMsg").className =
                  "small text-danger";
                return;
              }
              if (validCoupons[input]) {
                localStorage.setItem("appliedCoupon", input);
                renderCheckoutSummary();
              } else {
                document.getElementById("checkoutCouponMsg").textContent =
                  "Invalid coupon code. Try WELCOME10, SAVE20, MANGA15, or FREESHIP";
                document.getElementById("checkoutCouponMsg").className =
                  "small text-danger";
              }
            };
        }
      }

      // Payment Simulation Logic
      function showPaymentModal(method, onSuccess) {
        const modal = new bootstrap.Modal(
          document.getElementById("paymentModal")
        );
        const paymentFields = document.getElementById("paymentFields");
        const paymentForm = document.getElementById("paymentForm");
        const paymentError = document.getElementById("paymentError");
        const paymentLoading = document.getElementById("paymentLoading");
        const paymentResult = document.getElementById("paymentResult");
        paymentError.textContent = "";
        paymentResult.innerHTML = "";
        paymentLoading.style.display = "none";
        paymentForm.style.display = "";
        document.getElementById("payBtn").disabled = false;

        if (method === "card") {
          paymentFields.innerHTML = `
            <div class="mb-3">
              <label class="form-label">Card Number</label>
              <input type="text" class="form-control" id="cardNumber" maxlength="19" placeholder="1234 5678 9012 3456" required />
              <div class="invalid-feedback">Please enter a valid card number.</div>
            </div>
            <div class="mb-3 row">
              <div class="col-6">
                <label class="form-label">Expiry</label>
                <input type="text" class="form-control" id="cardExpiry" maxlength="5" placeholder="MM/YY" required />
                <div class="invalid-feedback">MM/YY format</div>
              </div>
              <div class="col-6">
                <label class="form-label">CVV</label>
                <input type="password" class="form-control" id="cardCVV" maxlength="3" placeholder="123" required />
                <div class="invalid-feedback">3 digit CVV</div>
              </div>
            </div>
            <div class="mb-3">
              <label class="form-label">Name on Card</label>
              <input type="text" class="form-control" id="cardName" required />
              <div class="invalid-feedback">Enter name on card.</div>
            </div>
          `;
        } else if (method === "upi") {
          paymentFields.innerHTML = `
            <div class="mb-3">
              <label class="form-label">UPI ID</label>
              <input type="text" class="form-control" id="upiId" placeholder="yourname@bank" required />
              <div class="invalid-feedback">Please enter a valid UPI ID.</div>
            </div>
          `;
        }

        paymentForm.onsubmit = function (e) {
          e.preventDefault();
          paymentError.textContent = "";
          let valid = true;
          // Basic validation
          if (method === "card") {
            const num = document.getElementById("cardNumber");
            const exp = document.getElementById("cardExpiry");
            const cvv = document.getElementById("cardCVV");
            const name = document.getElementById("cardName");
            if (!/^\d{4} \d{4} \d{4} \d{4}$/.test(num.value.trim())) {
              num.classList.add("is-invalid");
              valid = false;
            } else {
              num.classList.remove("is-invalid");
            }
            if (!/^\d{2}\/\d{2}$/.test(exp.value.trim())) {
              exp.classList.add("is-invalid");
              valid = false;
            } else {
              exp.classList.remove("is-invalid");
            }
            if (!/^\d{3}$/.test(cvv.value.trim())) {
              cvv.classList.add("is-invalid");
              valid = false;
            } else {
              cvv.classList.remove("is-invalid");
            }
            if (!name.value.trim()) {
              name.classList.add("is-invalid");
              valid = false;
            } else {
              name.classList.remove("is-invalid");
            }
          } else if (method === "upi") {
            const upi = document.getElementById("upiId");
            if (!/^[\w.-]+@[\w.-]+$/.test(upi.value.trim())) {
              upi.classList.add("is-invalid");
              valid = false;
            } else {
              upi.classList.remove("is-invalid");
            }
          }
          if (!valid) {
            paymentError.textContent = "Please fill all fields correctly.";
            return;
          }
          // Simulate payment
          paymentForm.style.display = "none";
          paymentLoading.style.display = "";
          setTimeout(() => {
            paymentLoading.style.display = "none";
            paymentResult.innerHTML = `<div class='alert alert-success'><i class='bi bi-check-circle'></i> Payment Successful!</div>`;
            document.getElementById("payBtn").disabled = true;
            setTimeout(() => {
              modal.hide();
              onSuccess();
            }, 1200);
          }, 1800);
        };
        modal.show();
      }

      // Place order logic
      document.addEventListener("DOMContentLoaded", function () {
        renderCheckoutSummary();
        // Place order handler
        const form = document.querySelector("form");
        if (form) {
          form.onsubmit = function (e) {
            e.preventDefault();
            const cart = JSON.parse(localStorage.getItem("cart") || "[]");
            if (!cart.length) {
              alert("Your cart is empty!");
              return false;
            }
            const paymentMethod = document.getElementById("payment").value;
            function showSuccessWithEbooks() {
              // Find E-Books
              const ebooks = cart.filter(
                (item) => item.type && item.type.toLowerCase() === "e-book"
              );
              // Save purchased physical books
              const offlineBooks = cart.filter(
                (item) => item.type && item.type.toLowerCase() !== "e-book"
              );
              if (offlineBooks.length) {
                let purchased = JSON.parse(
                  localStorage.getItem("purchasedBooks") || "[]"
                );
                purchased = purchased.concat(offlineBooks);
                localStorage.setItem(
                  "purchasedBooks",
                  JSON.stringify(purchased)
                );
              }
              let ebookLinks = "";
              if (ebooks.length) {
                ebookLinks =
                  `<div class='mt-3'><b>Your E-Book Downloads:</b><ul class='list-unstyled mb-0'>` +
                  ebooks
                    .map(
                      (item, idx) =>
                        `<li><a href='/downloads/ebook-demo.pdf' download class='btn btn-sm btn-primary mt-2'>Download: ${item.title}</a></li>`
                    )
                    .join("") +
                  `</ul></div>`;
              }
              form.innerHTML = `<div class='alert alert-success text-center'><i class='bi bi-check-circle'></i> Thank you! Your order has been placed.<br/>You will receive a confirmation email soon.${ebookLinks}</div>`;
              renderCheckoutSummary();
            }
            if (paymentMethod === "card" || paymentMethod === "upi") {
              showPaymentModal(paymentMethod, function () {
                localStorage.removeItem("cart");
                localStorage.removeItem("appliedCoupon");
                localStorage.removeItem("cartCount");
                showSuccessWithEbooks();
              });
            } else {
              localStorage.removeItem("cart");
              localStorage.removeItem("appliedCoupon");
              localStorage.removeItem("cartCount");
              showSuccessWithEbooks();
            }
            return false;
          };
        }
      });
    </script>

    <!-- Payment Simulation Modal -->
    <div
      class="modal fade"
      id="paymentModal"
      tabindex="-1"
      aria-labelledby="paymentModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog">
        <div class="modal-content checkout-dark-theme">
          <div class="modal-header text-white">
            <h5
              class="modal-title d-flex align-items-center gap-2"
              id="paymentModalLabel"
            >
              <i class="bi tesxt-white bi-credit-card-2-front"></i> Payment
              Simulation
            </h5>
            <button
              type="button"
              class="btn-close btn-close-white"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body p-4">
            <div class="mb-3 text-center">
              <i class="bi bi-shield-lock display-5 text-success mb-2"></i>
              <div class="fw-semibold">
                Enter your payment details to complete your order
              </div>
            </div>
            <form id="paymentForm" class="needs-validation" novalidate>
              <div id="paymentFields"></div>
              <div id="paymentError" class="text-danger small mb-2"></div>
              <button
                type="submit"
                class="btn btn-success w-100 mt-2"
                id="payBtn"
              >
                <i class="bi bi-arrow-right-circle me-1"></i>Pay Now
              </button>
            </form>
            <div
              id="paymentLoading"
              class="text-center my-4"
              style="display: none"
            >
              <div class="spinner-border text-primary mb-2" role="status"></div>
              <div class="fw-semibold">Processing payment...</div>
            </div>
            <div id="paymentResult" class="text-center my-3"></div>
          </div>
        </div>
      </div>
    </div>
  </body>
</html>
